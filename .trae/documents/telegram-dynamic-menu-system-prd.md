# Telegram 动态键盘菜单管理系统 - 产品需求文档

## 1. 产品概述

本系统旨在为 Telegram 机器人提供一个完全动态的键盘菜单管理解决方案，让管理员能够通过后台 Web 界面灵活配置 `/start` 命令显示的键盘按钮，支持多级菜单、按钮排序、多语言、图片显示和实时更新，彻底解决当前硬编码菜单系统的局限性。

该系统将显著提升 Telegram 机器人的可维护性和用户体验，使非技术人员也能轻松管理复杂的菜单结构和视觉内容。

## 2. 核心功能

### 2.1 用户角色

| 角色 | 注册方式 | 核心权限 |
|------|----------|----------|
| 超级管理员 | 系统预设账户 | 完全访问所有功能，包括系统配置和用户管理 |
| 菜单管理员 | 超级管理员邀请 | 可创建、编辑、删除菜单项，管理翻译、图片和权限 |
| 内容编辑员 | 管理员邀请 | 可编辑菜单内容、翻译和图片，无法修改菜单结构 |
| 查看者 | 邀请码注册 | 只能查看菜单配置和统计数据 |

### 2.2 功能模块

#### 2.2.1 菜单结构管理
- **层级菜单设计**: 支持无限层级的菜单嵌套
- **菜单项类型**: 支持命令执行、子菜单跳转、外部链接、纯文本显示
- **排序功能**: 拖拽式菜单项排序，支持同级和跨级移动
- **状态管理**: 菜单项启用/禁用状态控制
- **权限控制**: 基于用户角色的菜单项访问权限

#### 2.2.2 图片管理系统
- **图片上传**: 支持 JPG、PNG、GIF 格式图片上传
- **图片预览**: 实时预览上传的图片效果
- **图片编辑**: 基础的裁剪、缩放、压缩功能
- **图片库**: 统一的图片资源管理，支持分类和标签
- **图片关联**: 菜单项可选择关联图片，支持多语言不同图片
- **图片优化**: 自动压缩和格式转换，确保 Telegram 兼容性

#### 2.2.3 多语言支持
- **语言管理**: 动态添加/删除支持的语言
- **翻译界面**: 直观的翻译编辑器，支持批量翻译
- **翻译状态**: 翻译完成度追踪和提醒
- **回退机制**: 缺失翻译时的默认语言回退
- **图片本地化**: 不同语言可配置不同的图片资源

#### 2.2.4 按钮配置
- **按钮文本**: 支持多语言按钮文本配置
- **按钮动作**: 配置按钮点击后的行为（命令、跳转、链接等）
- **按钮样式**: 支持不同的按钮布局（单列、双列、自定义）
- **条件显示**: 基于用户状态、时间、权限的条件显示
- **图片按钮**: 支持带图片的按钮显示

#### 2.2.5 实时预览
- **菜单预览**: 实时预览菜单在 Telegram 中的显示效果
- **多语言预览**: 切换不同语言查看预览效果
- **设备适配**: 预览不同设备上的显示效果
- **图片预览**: 预览图片在 Telegram 中的显示效果

#### 2.2.6 数据统计
- **使用统计**: 菜单项点击次数、用户行为分析
- **性能监控**: 菜单加载时间、响应速度监控
- **错误追踪**: 菜单配置错误和异常情况记录
- **图片统计**: 图片使用频率、存储空间统计

## 3. 图片功能详细需求

### 3.1 图片上传功能
- **支持格式**: JPG、PNG、GIF、WebP
- **文件大小**: 单个文件最大 10MB
- **图片尺寸**: 建议尺寸 800x600，最大 2048x2048
- **批量上传**: 支持一次上传多个图片文件
- **上传进度**: 显示上传进度条和状态
- **错误处理**: 详细的错误提示和重试机制

### 3.2 图片显示逻辑
- **有图片时**: 发送图片消息 + 键盘按钮
- **无图片时**: 仅发送文本消息 + 键盘按钮
- **图片加载失败**: 自动回退到文本模式
- **图片缓存**: 智能缓存机制，提升加载速度

### 3.3 图片管理界面
- **图片库**: 统一的图片资源管理中心
- **分类管理**: 支持图片分类和标签系统
- **搜索功能**: 按名称、标签、上传时间搜索图片
- **批量操作**: 批量删除、移动、标签管理
- **使用追踪**: 显示图片被哪些菜单项使用

### 3.4 图片多语言支持
- **语言关联**: 每个菜单项可为不同语言配置不同图片
- **图片回退**: 当前语言无图片时，使用默认语言图片
- **批量配置**: 支持批量为多语言配置相同图片

## 4. 技术要求

### 4.1 前端技术栈
- **框架**: React 18+ with TypeScript
- **路由**: React Router v6
- **状态管理**: Zustand
- **UI 组件**: Tailwind CSS + Headless UI
- **表单处理**: React Hook Form + Zod 验证
- **图片处理**: React Image Crop, React Dropzone
- **数据获取**: Laravel Inertia.js

### 4.2 后端技术栈
- **框架**: Laravel 10+
- **数据库**: MySQL 8.0+
- **文件存储**: Laravel Storage (支持本地和云存储)
- **图片处理**: Intervention Image
- **API**: RESTful API + Inertia.js
- **缓存**: Redis
- **队列**: Laravel Queue (图片处理)

### 4.3 数据库设计
- **telegram_menu_items**: 菜单项基础信息
- **telegram_menu_translations**: 菜单项多语言翻译
- **telegram_menu_images**: 图片资源管理
- **telegram_menu_item_images**: 菜单项与图片关联
- **telegram_languages**: 支持的语言列表
- **telegram_menu_stats**: 使用统计数据

### 4.4 性能要求
- **响应时间**: 页面加载时间 < 2秒
- **图片加载**: 图片显示时间 < 1秒
- **并发支持**: 支持 100+ 并发用户
- **存储优化**: 图片自动压缩，减少存储空间

## 5. 用户体验设计

### 5.1 界面设计原则
- **简洁直观**: 清晰的信息层级和操作流程
- **响应式设计**: 适配桌面、平板、手机设备
- **无障碍访问**: 支持键盘导航和屏幕阅读器
- **视觉一致性**: 统一的设计语言和交互模式

### 5.2 操作体验
- **拖拽排序**: 直观的拖拽式菜单排序
- **实时预览**: 配置更改后立即预览效果
- **批量操作**: 支持批量编辑、删除、移动
- **撤销重做**: 支持操作撤销和重做功能
- **自动保存**: 定时自动保存，防止数据丢失

### 5.3 图片体验
- **拖拽上传**: 支持拖拽文件到指定区域上传
- **图片预览**: 上传前预览图片效果
- **裁剪工具**: 内置图片裁剪和调整工具
- **格式转换**: 自动转换为 Telegram 支持的格式

## 6. 安全要求

### 6.1 权限控制
- **角色权限**: 基于角色的访问控制 (RBAC)
- **操作审计**: 记录所有关键操作日志
- **数据隔离**: 不同租户数据完全隔离

### 6.2 文件安全
- **文件验证**: 严格的文件类型和内容验证
- **病毒扫描**: 上传文件的安全扫描
- **访问控制**: 图片文件的访问权限控制
- **存储加密**: 敏感文件的加密存储

### 6.3 数据安全
- **输入验证**: 所有用户输入的严格验证
- **SQL 注入防护**: 使用 ORM 防止 SQL 注入
- **XSS 防护**: 输出内容的 XSS 过滤
- **CSRF 保护**: 表单提交的 CSRF 令牌验证

## 7. 部署和维护

### 7.1 部署要求
- **服务器**: Linux/Windows Server
- **Web 服务器**: Nginx/Apache
- **PHP**: 8.1+
- **数据库**: MySQL 8.0+ 或 PostgreSQL 13+
- **存储**: 至少 50GB 可用空间

### 7.2 监控和日志
- **应用监控**: 性能指标和错误监控
- **访问日志**: 详细的用户操作日志
- **系统日志**: 系统运行状态和错误日志
- **图片统计**: 图片使用和存储统计

### 7.3 备份策略
- **数据备份**: 每日自动数据库备份
- **文件备份**: 定期图片文件备份
- **配置备份**: 系统配置文件备份
- **恢复测试**: 定期备份恢复测试

## 8. 项目里程碑

### 阶段一：基础架构 (2周)
- 数据库设计和迁移
- 基础模型和服务类
- 用户认证和权限系统
- 基础 UI 框架搭建

### 阶段二：核心功能 (3周)
- 菜单结构管理
- 多语言支持
- 基础图片上传功能
- 菜单配置界面

### 阶段三：高级功能 (2周)
- 图片管理系统
- 实时预览功能
- 数据统计和分析
- 性能优化

### 阶段四：测试和部署 (1周)
- 功能测试和 Bug 修复
- 性能测试和优化
- 部署和上线准备
- 文档编写和培训

## 9. 风险评估

### 9.1 技术风险
- **图片处理性能**: 大量图片处理可能影响系统性能
- **存储空间**: 图片文件占用大量存储空间
- **Telegram API 限制**: API 调用频率和文件大小限制

### 9.2 缓解措施
- **异步处理**: 使用队列异步处理图片
- **CDN 加速**: 使用 CDN 加速图片加载
- **智能压缩**: 自动压缩图片减少存储
- **缓存策略**: 合理的缓存策略减少 API 调用

## 10. 成功指标

- **功能完整性**: 100% 需求功能实现
- **性能指标**: 页面加载时间 < 2秒，图片加载 < 1秒
- **用户满意度**: 用户反馈评分 > 4.5/5
- **系统稳定性**: 99.9% 系统可用性
- **安全性**: 零安全漏洞
